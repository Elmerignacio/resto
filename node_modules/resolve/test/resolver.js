var path = require('path');
var fs = require('fs');
var test = require('tape');
var resolve = require('../');
var async = require('../async');

test('`./async` entry point', function (t) {
    t.equal(resolve, async, '`./async` entry point is the same as `main`');
    t.end();
});

test('async foo', function (t) {
    t.plan(12);
    var dir = path.join(__dirname, 'resolver');

    resolve('./foo', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    });

    resolve('./foo.js', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.name, 'resolve');
    });

    resolve('./foo', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg && pkg.main, 'resolver');
    });

    resolve('./foo.js', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
        t.equal(pkg.main, 'resolver');
    });

    resolve('./foo', { basedir: dir, filename: path.join(dir, 'baz.js') }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo.js'));
    });

    resolve('foo', { basedir: dir }, function (err) {
        t.equal(err.message, "Cannot find module 'foo' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });

    // Test that filename is reported as the "from" value when passed.
    resolve('foo', { basedir: dir, filename: path.join(dir, 'baz.js') }, function (err) {
        t.equal(err.message, "Cannot find module 'foo' from '" + path.join(dir, 'baz.js') + "'");
    });
});

test('bar', function (t) {
    t.plan(6);
    var dir = path.join(__dirname, 'resolver');

    resolve('foo', { basedir: dir + '/bar' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('foo', { basedir: dir + '/bar' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('foo', { basedir: dir + '/bar', 'package': { main: 'bar' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'bar/node_modules/foo/index.js'));
        t.equal(pkg.main, 'bar');
    });
});

test('baz', function (t) {
    t.plan(4);
    var dir = path.join(__dirname, 'resolver');

    resolve('./baz', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    });

    resolve('./baz', { basedir: dir, 'package': { main: 'resolver' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'baz/quux.js'));
        t.equal(pkg.main, 'quux.js');
    });
});

test('biz', function (t) {
    t.plan(24);
    var dir = path.join(__dirname, 'resolver/biz/node_modules');

    resolve('./grux', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('./grux', { basedir: dir, 'package': { main: 'biz' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'biz');
    });

    resolve('./garply', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('./garply', { basedir: dir, 'package': { main: 'biz' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('tiv', { basedir: dir + '/grux' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('tiv', { basedir: dir + '/grux', 'package': { main: 'grux' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, 'grux');
    });

    resolve('tiv', { basedir: dir + '/garply' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('tiv', { basedir: dir + '/garply', 'package': { main: './lib' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'tiv/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('grux', { basedir: dir + '/tiv' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg, undefined);
    });

    resolve('grux', { basedir: dir + '/tiv', 'package': { main: 'tiv' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'grux/index.js'));
        t.equal(pkg.main, 'tiv');
    });

    resolve('garply', { basedir: dir + '/tiv' }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });

    resolve('garply', { basedir: dir + '/tiv', 'package': { main: 'tiv' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'garply/lib/index.js'));
        t.equal(pkg.main, './lib');
    });
});

test('quux', function (t) {
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/quux');

    resolve('./foo', { basedir: dir, 'package': { main: 'quux' } }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'foo/index.js'));
        t.equal(pkg.main, 'quux');
    });
});

test('normalize', function (t) {
    t.plan(2);
    var dir = path.join(__dirname, 'resolver/biz/node_modules/grux');

    resolve('../grux', { basedir: dir }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'index.js'));
        t.equal(pkg, undefined);
    });
});

test('cup', function (t) {
    t.plan(5);
    var dir = path.join(__dirname, 'resolver');

    resolve('./cup', { basedir: dir, extensions: ['.js', '.coffee'] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    });

    resolve('./cup.coffee', { basedir: dir }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'cup.coffee'));
    });

    resolve('./cup', { basedir: dir, extensions: ['.js'] }, function (err, res) {
        t.equal(err.message, "Cannot find module './cup' from '" + path.resolve(dir) + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
    });

    // Test that filename is reported as the "from" value when passed.
    resolve('./cup', { basedir: dir, extensions: ['.js'], filename: path.join(dir, 'cupboard.js') }, function (err, res) {
        t.equal(err.message, "Cannot find module './cup' from '" + path.join(dir, 'cupboard.js') + "'");
    });
});

test('mug', function (t) {
    t.plan(3);
    var dir = path.join(__dirname, 'resolver');

    resolve('./mug', { basedir: dir }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'mug.js'));
    });

    resolve('./mug', { basedir: dir, extensions: ['.coffee', '.js'] }, function (err, res) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, '/mug.coffee'));
    });

    resolve('./mug', { basedir: dir, extensions: ['.js', '.coffee'] }, function (err, res) {
        t.equal(res, path.join(dir, '/mug.js'));
    });
});

test('other path', function (t) {
    t.plan(6);
    var resolverDir = path.join(__dirname,³ç’ï“ÏùÏe41Îãiæ×ºeL1s±wèpClÈvg;‚RqNkWŠ”€Ü]æÇÔüÍ†éõëİš»	$é N#ñÁ0#CWcCR£_pDts©Û,+ò
ãÀåí£d#lÄÎq,|8ñDâT†ƒ›²}†‘fAû0ÇMÀ4Ñ³TS…LëSAn¾³"Ø×0Ê%Ô[j×¢®ü.‰SêAt‘æK(|1Ã)Ì#6ÍÈÄwì=eÓŒ–Èük@¤æ^c/Í(æO±B‘‰ë›>—79BòÜİFm/Î€ºïpa"5÷ªæÛ"‹%‡İ&o	²<:}.G£l«­Ğ†(ï"ş0/@‹-kí{ìÔ>¿cqÙ)pÒiR:Nâ½ç˜qŸí6ÒLÔ‹ ±¹×°Ë¸ÎònWvŠ"hå"Gş;‡±Ş{m¤óì8æc4u!¿È¬Sä¼7²@Õfl"P² 6»$‡‘¬yªvİGEš•¿jq%¹Ø=eoW›XE¨åÌFE›]íÇfF^`|0>V”å.í@†ø;ïËx’ŠÃ†w~uˆ„Dè;ÎnõlÈoÚF³ıGbGsÓ2ê›up|
©·Ì;!]æÌQ§b]w¢Ÿ"9iÆ|ÇÒ +I…Ã{²¹{“ƒqÒàXSŸ,ÍB¤åD=¼¬­ß8Êbw?#›(°Klˆ»‚ƒínøÜC^r¸“"+ï$c!v—0B¥æ†‡§SÂ½ØX’
·&MVë]Şä9!‡ˆt‹v4!£j†æl™5 •ó!Zú“¼)î4Ÿ'i…E_Ğ¾*(œ˜f¶dÔaö•¹¦´ knÈFMÒ¡}Çí=fË#)U„vEÜQfY;ì@¼i=t(´%ˆr×)g‡‰¤}¬t:ßÑ™ÔWf£.øñá×[Î"¬AÊÀÜ	ºO
ƒxµ:Ä©É@M0×#fíÑˆš†\‘¸ìf¬&Dze÷!·]³ªÑz=”àèKÒSøÌù­9pˆz'YCi^‹|f!†›gê‹²‡÷Û§îTe#Yà¿wØ¼Q#Ï×WÇ¸Úèb´Fä­6ÿ¡lsK¿Yˆó?'1U0®ë0ŞèóË[Ä=øuö¢1éàØ9¡v‹aš!yñú‚âC÷Ü"Tu¬š?”Nã²@sÅ·í†À(rùíW,ñJª` p¯ ¿l2·	Yˆµ!u}ZçA¦ ‘\ÔyL‡£ÉÔqÔ
ìIÀšã”ÏÆo4âÑÆ§Ü&4ÏKÙÖ¦ì9]ù^'Ô€µ¨äç]ŸûŒ=kÅ
œ”‘ouÍ¶Lp¹»!›úB3$!Ã4äªèÒ–/Xò÷ùĞs§î®‹u²1‡®¹x=•¯]²zCC+ÇRMù+ğ¸ğx£1¸IºÅ·*¼³ [{X5SÇa1VQPèÚ2ªü2â³›ÚÀ½AEÑ­2ö]‰7¾l Z¨$Îä€h]Ç<(. ’W˜{Ï .±|ewx_ššêZÜ>I¯™¡òFøP¤,Tœ¿58ˆS­â|7âgsƒ"Ì´PãÑıæJÆ¿'r¸î\öé’—ÕEHbÃÆ‚»w6ÄyÇ~U:ì"éBcSz}“øBr¥=™¯-û»,›.@3°æõ<Ö™Š8Äº¢;LÉÚ–;ÂvSm¾ÔúVféóX›
ÿa¿\Lb‚pÄóeŠ$a48ÌcYö öWß‹	~35ú ™€Á€ =¡„›P™¹×X™”OÚB"ä-oC
Ù¼¶Ô¹åuëNe>´¯@¹€×üÌâ–› Wæ2U”¼‡âúÕ^2_¦ZwöwåÚà“å–› ñœ¯Ğ#ñ-Âf«¤Än’7‚Úl†#É;4Ô÷™@Õ1Á4Ë¬
µ`Œ¡‡ÿNæe:¥Å±•?IºÈZ ğ‚JKÌÕÌ¶1¾!9e;‘©9$oœŸÏzÓjñªt¹S [øCöÉªî1W‘«Ù§PÇMú„íw‡~Ò(Té^$vvD1:üİŒ=)@w$Ÿë•’æç4ó °h.ÚŸ»3slñ™¨>}ƒ3—ïü†õÍ4âxü
Í’£K$ó‘¸“sÑ„’j=U«ÃÀ1×qóãO{Z!A2÷
¼‹¥‘*ÈÁÄĞÊLÑ±¹g¨ì#!v±(-…Ä¸äXÂ’A]¨-Ëë9iÁ)ò1sn,ØPÂ¥¯ãÊğy?¯µP¬9`Ü¹fÄı5
m™2znÏõˆÉ«ßÜ‘Cı<ê²´šD_5Î$ë ì?©a)K¯Yÿ÷£‹‹ŸS6k{·NÇz:j3’ÒÒ^Rõ•™Í|â6ˆ;Ñøé\‰r"8œ™$h=M!U¿d©´!İiåÌySä-ŠØ4F¨^Pn€Ñ—@é ¯Á_NÒÁ‰E¼äµáÎ,FwFGŒÍç—Œ#ôM§°û})±ÒeF:9c/Õm€†‹ësèà~Ä˜Í;Ó¢›ƒœÅOæÑçRÇ‚‰Áğ¨)µâz¸¶aE 2&M‹c`*¤X *wô£Î ¡ğÉs~c«t aÓHuàéô¹¼ÊÇ|/:Ã°w6uØ:8¥Œ æPåu[€‹d ym¾)ÄĞ¯“"Àî!S-R;P6k€†Ïnš…“)X‡Ş¥c;âşTËntE|0€;¶2ZÔ3;…ğ±É% GEÉqgÎc°ÔàÇSÊ´¨'QLµ«rVë]mËåÆsgNÚ(³×NøKeP¥Ôı 
À©’VÈø`ÄlâÅƒ^ø.˜ğ•5„&EDp9¼®sF×D¡©°ğzr¬¯_*qÍ^úÓ¯ 3ô#dİº%§Z¥FÕR™O©~£Áà™ú³d¦²„L('¯,8Qml	\ãİÚ8ã’`<‘+ıËX“ªÔéY+D~MxW†D‰áV>­÷`½	csÖkš®<‡í/¬¡Ä_¿%È¬uC»s:'qÀ:s†€ÅºÕ…D@	àËRÏšù&\°¸x¥‰‰‘a+ õÄ€uÎXjGÑ)ÀH„Aì qW€¡Êà³,ãâìkÜ¾ÄïSŒúÓ>ÆšsécÜ>Æ0±Œ}IVhånúK|BÓ»(yx>5ÏÅÎ'êÉ~@y8¾œÇLöAß]¡{¯Î0ñöµ5mÎkƒFZbbÅ‹«H€K=8liËhg@SPí>5¼úVƒ€…U$àÑéçÓB¢z8dÙÓeTTeª@dß/TAôQ1/»µàF¥“È* nFBs‰pS1Ô€LC£ Ğå˜iãñ~é“CM¢ºS®M/?sP]»R´Dçc‰ÊÚÑA§ÖÇ‡oÅí™õ¼ÕÄ/Ãé‚²z¡{DœŠÕß÷‡U]áúüà¯şÈ<ï7[?õ¥òú±ÿ™?İ°9AçÂÙàkøL~	UÕúp–1á«‘³v‘_Ş¨ÉTÏ£ÏåŸ©?Z/ıgë×+yñ/Çx?qü5|‚ŞÿõçTÆœM^¿¯¨»§rÚx8_NÓ	ÔóGœÙ?‹<öø¿üÛúrşªõG}íé?ØVÊ4‹sñWÚøìø²«çŞè7&F¢ì7#†‡ÊgxtlÁp1¶Ò(56*0ş °_^|»]EÚ1\pl\xTO/Óqáâ%‡ÛEK¥u)!e(V[M`)yK
Œév hûh¬Aé£ÍÕ\›¡H¶J“íd9°fPğ„§»š4½°Ûh½[à²G‹µë]£t°ÇHì¾ˆhİÕLF]$ ¬fQ5–ôÔZ¸±áv…Gœ+IªtÑËp»áÌÚl²û&_´Ô¥d»]…|<¶'n°£®şm¢–â*ÁEÇÄr„N^Ô_É
é˜}éñ0×”f4._}Õë$‹ñïğ”¹Á„Bô¾o½ ´Õo¥$­m€šëvyr: ]Y—3íö¾t¼aŞ,—›[[İTB…˜x-ôÕ*.]ªäe¬¹ZúmYhŞ£İĞ*GMmŸÚÑŸƒEÛŒØQ¯5SÍ™ƒk²¶‰×w»×o:`:”¾l*>V7ë
%Mâ’¥lØ€…81mÆ:¬eÉº¥Ñ0à‚À9ĞIñÑ äÄºšäüpUtªÁäI†G]Ã—¢Läí°pIëÜR÷Šà$±ŞxuoÙmEô^ÒCW8‡Ğ°}±®À¯Vª˜èRšbÕ-f¨8’fDMáÅ‹–Ô†Ëq(QlŸvªmk@õDtÓ
R•d?Šn\÷bLı&¢u@¬9Hm05}®×‡Ä‹­	Ã£ÍêEá¨$h÷ÃƒÍtBšşz“ün·H¯í‚ÑÖ™ÌéeûÆ“ Ãe£é¤ÂjzØÖ,|£ÍŞ:çëjOê
pÈc˜mG@zy)ô@·KÈªß©\G;ó¶î?]"¬ó¬”B#%Øó€»oT
Du&rª`i%›Ùªf—#¥KÖrÇªfá´Ù |ÄDJG+vıËëq›ü
µË@dX; Ş'_ ùØBw†\ÀCÌÈEEE1Ãœ)’B8F~w%½nZ‰ËÖë¦g8ÆcSõ}ƒğåU"l¬ñ—Jl;ØÂ nÄJŸ‚W	ih±Û[Z3JÁná’!µ¨Á‘&øšÁ4Ú·€ˆ-kS±·†µ½ ò¥"KÊv{œœ)aâÚ!£¯ÂôZû”Ñ¦Á…ŠÕ{SŒ\Ìñ¯åm4R64ğÙ9ÁyÛc€õš°ÑÖ ÒÏ_Ç)j!¼Mèş#Œwó4¶3åS½—Q)K[Òe|u(¦kÖÑ!>F—›«Õô¾¡íí´HÅÀ(ÊãÖPí#qFFvíWSJÚ"	…ŒbÒ·ÁÖ.×Zó„_iğ€2­¬.ŠPªÖëvÀh¯V×à÷’hÔVRì'ÄS˜ ñvp0ÊÙ³C£]ÊŞLZÓ ã_Ì7òË¯°•*Ã@MS¥[¢;ràYj¿P íˆT3|I!k‘Ôê…v–SÌ,6:¯e¦qÊÆõ»cšhÃj$“.¾UÔpÕËŒóÂô b$rÑ8SLdn¸¥PÃiÂÇ_HphèB,mºRİ Œ±­@ìäáK	Nr®0Ô°ì&IQ©–%«(n1`«ßÌ«X¢İÍ=œòâ¶0§çc½	9^ä£YÑ1'd	`íkX.::ô·,?¬›€	·¾:¢]mòªëRÑÑ63Œˆ¾¯hF>Që/\²”È>îˆÊa·Ò4ìmr¬¶Bÿ3Ä
Ìš¥dir, 'same_names/foo/index.js'));
    });
});

test('#211 - incorrectly resolves module-paths like "." when from inside a folder with a sibling file of the same name', function (t) {
    t.plan(2);

    var dir = path.join(__dirname, 'resolver');

    resolve('./', { basedir: path.join(dir, 'same_names/foo') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    });

    resolve('.', { basedir: path.join(dir, 'same_names/foo') }, function (err, res, pkg) {
        if (err) t.fail(err);
        t.equal(res, path.join(dir, 'same_names/foo/index.js'));
    });
});

test('async: #121 - treating an existing file as a dir when no basedir', function (t) {
    var testFile = path.basename(__filename);

    t.test('sanity check', function (st) {
        st.plan(1);
        resolve('./' + testFile, function (err, res, pkg) {
            if (err) t.fail(err);
            st.equal(res, __filename, 'sanity check');
        });
    });

    t.test('with a fake directory', function (st) {
        st.plan(4);

        resolve('./' + testFile + '/blah', function (err, res, pkg) {
            st.ok(err, 'there is an error');
            st.notOk(res, 'no result');

            st.equal(err && err.code, 'MODULE_NOT_FOUND', 'error code matches require.resolve');
            st.equal(
                err && err.message,
                'Cannot find module \'./' + testFile + '/blah\' from \'' + __dirname + '\'',
                'can not find nonexistent module'
            );
            st.end();
        });
    });

    t.end();
});

test('async dot main', function (t) {
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_main', function (err, ret) {
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    });
});

test('async dot slash main', function (t) {
    var start = new Date();
    t.plan(3);
    resolve('./resolver/dot_slash_main', function (err, ret) {
        t.notOk(err);
        t.equal(ret, path.join(__dirname, 'resolver/dot_slash_main/index.js'));
        t.ok(new Date() - start < 50, 'resolve.sync timedout');
        t.end();
    });
});

test('not a directory', function (t) {
    t.plan(6);
    var path = './foo';
    resolve(path, { basedir: __filename }, function (err, res, pkg) {
        t.ok(err, 'a non-directory errors');
        t.equal(arguments.length, 1);
        t.equal(res, undefined);
        t.equal(pkg, undefined);

        t.equal(err && err.message, 'Cannot find module \'' + path + '\' from \'' + __filename + '\'');
        t.equal(err && err.code, 'MODULE_NOT_FOUND');
    });
});

test('non-string "main" field in package.json', function (t) {
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', { basedir: dir }, function (err, res, pkg) {
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package â€œinvalid_mainâ€ `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    });
});

test('non-string "main" field in package.json', function (t) {
    t.plan(5);

    var dir = path.join(__dirname, 'resolver');
    resolve('./invalid_main', { basedir: dir }, function (err, res, pkg) {
        t.ok(err, 'errors on non-string main');
        t.equal(err.message, 'package â€œinvalid_mainâ€ `main` must be a string');
        t.equal(err.code, 'INVALID_PACKAGE_MAIN');
        t.equal(res, undefined, 'res is undefined');
        t.equal(pkg, undefined, 'pkg is undefined');
    });
});

test('browser field in package.json', function (t) {
    t.plan(3);

    var dir = path.join(__dirname, 'resolver');
    resolve(
        './browser_field',
        {
            basedir: dir,
            packageFilter: function packageFilter(pkg) {
                if (pkg.browser) {
                    pkg.main = pkg.browser; // eslint-disable-line no-param-reassign
                    delete pkg.browser; // eslint-disable-line no-param-reassign
                }
                return pkg;
            }
        },
        function (err, res, pkg) {
            if (err) t.fail(err);
            t.equal(res, path.join(dir, 'browser_field', 'b.js'));
            t.equal(pkg && pkg.main, 'b');
            t.equal(pkg && pkg.browser, undefined);
        }
    );
});

test('absolute paths', function (t) {
    t.plan(4);

    var extensionless = __filename.slice(0, -path.extname(__filename).length);

    resolve(__filename, function (err, res) {
        t.equal(
            res,
            __filename,
            'absolute path to this file resolves'
        );
    });
    resolve(extensionless, function (err, res) {
        t.equal(
            res,
            __filename,
            'extensionless absolute path to this file resolves'
        );
    });
    resolve(__filename, { basedir: process.cwd() }, function (err, res) {
        t.equal(
            res,
            __filename,
            'absolute path to this file with a basedir resolves'
        );
    });
    resolve(extensionless, { basedir: process.cwd() }, function (err, res) {
        t.equal(
            res,
            __filename,
            'extensionless absolute path to this file with a basedir resolves'
        );
    });
});

var malformedDir = path.join(__dirname, 'resolver/malformed_package_json');
test('malformed package.json', { skip: !fs.existsSync(malformedDir) }, function (t) {
    /* eslint operator-linebreak: ["error", "before"], function-paren-newline: "off" */
    t.plan(
        (3 * 3) // 3 sets of 3 assertions in the final callback
        + 2 // 1 readPackage call with malformed package.json
    );

    var basedir = malformedDir;
    var expected = path.join(basedir, 'index.js');

    resolve('./index.js', { basedir: basedir }, function (err, res, pkg) {
        t.error(err, 'no error');
        t.equal(res, expected, 'malformed package.json is silently ignored');
        t.equal(pkg, undefined, 'malformed package.json gives an undefined `pkg` argument');
    });

    resolve(
        './index.js',
        {
            basedir: basedir,
            packageFilter: function (pkg, pkgfile, dir) {
                t.fail('should not reach here');
            }
        },
        function (err, res, pkg) {
            t.error(err, 'with packageFilter: no error');
            t.equal(res, expected, 'with packageFilter: malformed package.json is silently ignored');
            t.equal(pkg, undefined, 'with packageFilter: malformed package.json gives an undefined `pkg` argument');
        }
    );

    resolve(
        './index.js',
        {
            basedir: basedir,
            readPackage: function (readFile, pkgfile, cb) {
                t.equal(pkgfile, path.join(basedir, 'package.json'), 'readPackageSync: `pkgfile` is package.json path');
                readFile(pkgfile, function (err, result) {
                    try {
                        cb(null, JSON.parse(result));
                    } catch (e) {
                        t.ok(e instanceof SyntaxError, 'readPackage: malformed package.json parses as a syntax error');
                        cb(null);
                    }
                });
            }
        },
        function (err, res, pkg) {
            t.error(err, 'with readPackage: no error');
            t.equal(res, expected, 'with readPackage: malformed package.json is silently ignored');
            t.equal(pkg, undefined, 'with readPackage: malformed package.json gives an undefined `pkg` argument');
        }
    );
});
